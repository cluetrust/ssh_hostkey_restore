---

- name: gather os specific variables
  include_vars: "{{ item }}"
  with_first_found:
    - "{{ ansible_distribution }}-{{ ansible_distribution_major_version}}.yml"
    - "{{ ansible_distribution }}.yml"
  tags: vars
  
- name: make sure machine directory and keys subdir exist
  local_action: file path="{{ local_key_dir }}" state=directory follow=yes mode=0755
  become: no
  
- name: Check to see if ssh_host_dsa_key exists
  local_action: stat path="{{ local_key_dir }}/{{ item.file_name }}"
  register: key_file
  with_items: "{{ ssh_key_config }}"
  ignore_errors: True
  become: no

- name: Generate ssh_host_dsa_key
  local_action: shell ssh-keygen -f "{{ local_key_dir }}/{{ item.item.file_name }}" -C 'root@{{ inventory_hostname }}' -N '' -t {{ item.item.algorithm }}
  with_items: "{{ key_file.results }}"
  when: item.stat.exists == False
  become: no

- name: Copy SSH Host private keys
  copy: src={{ local_key_dir }}/{{ item.file_name }}
        dest={{ssh_key_dir}}/{{ item.file_name }}
        owner=root group=root mode=0600
  with_items: "{{ ssh_key_config }}"
  notify:
    - restart sshd

- name: Copy SSH Host public keys
  copy: src={{ local_key_dir }}/{{ item.file_name }}.pub
        dest={{ssh_key_dir}}/{{ item.file_name }}.pub
        owner=root group=root mode=0644
  with_items: "{{ ssh_key_config }}"
  notify:
    - restart sshd

- name: remove unnecessary old lines from sshd config (reduce warnings)
  lineinfile:  dest=/etc/ssh/sshd_config state=absent regexp="{{ item }}" 
  with_items: 
    - "^LookupClientHostnames" 
    - "^VerifyReverseMapping"
    - "^MaxAuthTriesLog" 
    - "^RhostsAuthentication" 
    - "^RhostsRSAAuthentication"
    - "^RSAAuthentication"
    - "^ServerKeyBits"
    - "^KeyRegenerationInterval"
    - "^UsePrivilegeSeparation"
    
- name: update sshd config to reduce the duration of bad connections
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^LoginGraceTime'
    line: LoginGraceTime 8
  notify:
    - restart sshd
    
- name: run handlers to clear SSH if necessary
  meta: flush_handlers
  
- name: Verify that we can talk to the servers
  wait_for:
    host: "{{ ansible_host }}"
    port: 22
    delay: 1
    timeout: "{{ssh_hostkey_restore_timeout}}"
    state: started
  delegate_to: "localhost"
  become: no
